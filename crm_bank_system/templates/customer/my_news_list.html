{% extends "base_user.html" %}
{% load static %}
{% block title %}–ú–æ–∏ –ù–æ–≤–æ—Å—Ç–∏{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/news.css' %}">
{% endblock %}

{% block content %}
<section class="news-section">
    <h1>–ú–æ–∏ –ù–æ–≤–æ—Å—Ç–∏</h1>

    <a href="{% url 'add_news' %}" class="btn btn-primary mb-3">–î–æ–±–∞–≤–∏—Ç—å –ù–æ–≤–æ—Å—Ç—å</a>

    <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
    <form method="get" action="" class="d-flex mb-4 p-3">
        <input type="text" name="search" class="form-control me-2" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –∏–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç—É" value="{{ request.GET.search }}">
        <select name="sort" class="form-select me-2">
            <option value="">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
            <option value="asc" {% if request.GET.sort == 'asc' %}selected{% endif %}>A - Z</option>
            <option value="desc" {% if request.GET.sort == 'desc' %}selected{% endif %}>Z - A</option>
        </select>
        <button type="submit" class="btn btn-secondary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </form>

    <!-- –°–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π -->
    {% if news_list %}
    <div class="news-list">
        {% for news in news_list %}
        <div class="news-item mb-4 p-3 border rounded">
            <h2>{{ news.title }}</h2>
            <p><strong>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</strong> {{ news.created_at|date:"d M Y H:i" }}</p>
            <p>{{ news.content|truncatechars:100 }}</p>

            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="news-actions d-flex align-items-center mt-2">
                <div class="me-3">
                    <!-- –õ–∞–π–∫ -->
                    <button
                        class="btn btn-sm btn-outline-success like-btn {% if news.is_liked %}active{% endif %}"
                        data-news-id="{{ news.id }}"
                        data-action="like">
                        üëç
                    </button>
                    <span id="likes-count-{{ news.id }}">{{ news.likes_count }}</span>

                    <!-- –î–∏–∑–ª–∞–π–∫ -->
                    <button
                        class="btn btn-sm btn-outline-danger dislike-btn {% if news.is_disliked %}active{% endif %}"
                        data-news-id="{{ news.id }}"
                        data-action="dislike">
                        üëé
                    </button>
                    <span id="dislikes-count-{{ news.id }}">{{ news.dislikes_count }}</span>
                </div>
                <a href="{% url 'news_detail' news_id=news.id %}" class="btn btn-sm btn-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                <a href="{% url 'edit_news' news_id=news.id %}" class="btn btn-sm btn-warning ms-2">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <form method="post" action="{% url 'delete_news' news_id=news.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger ms-2">–£–¥–∞–ª–∏—Ç—å</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π.</p>
    {% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    const csrftoken = '{{ csrf_token }}';

    document.addEventListener('DOMContentLoaded', () => {
        const reactionButtons = document.querySelectorAll('.like-btn, .dislike-btn');

        reactionButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const newsId = button.getAttribute('data-news-id');
                const action = button.getAttribute('data-action');

                fetch(`/news/${newsId}/${action}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                })
                .then(response => response.json())
                .then(data => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                    document.getElementById(`likes-count-${newsId}`).textContent = data.likes_count;
                    document.getElementById(`dislikes-count-${newsId}`).textContent = data.dislikes_count;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
                    const likeButton = document.querySelector(`.like-btn[data-news-id="${newsId}"]`);
                    const dislikeButton = document.querySelector(`.dislike-btn[data-news-id="${newsId}"]`);

                    if (data.is_liked) {
                        likeButton.classList.add('active');
                        dislikeButton.classList.remove('active');
                    } else {
                        likeButton.classList.remove('active');
                    }

                    if (data.is_disliked) {
                        dislikeButton.classList.add('active');
                        likeButton.classList.remove('active');
                    } else {
                        dislikeButton.classList.remove('active');
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
            });
        });
    });
</script>
{% endblock %}
